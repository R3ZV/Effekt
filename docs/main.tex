\documentclass[14pt]{extarticle}

% --------------------------------------------------
% Packages
% --------------------------------------------------
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{amsmath, amssymb, amsfonts}
\usepackage{graphicx}
\usepackage{geometry}
\usepackage{enumitem}
\usepackage{float}
\usepackage[linesnumbered,ruled,vlined]{algorithm2e}
\usepackage{listings}
\usepackage{xcolor}
\usepackage{caption}
\usepackage{hyperref}
\usepackage{cleveref}
\usepackage{parskip} % For better paragraph spacing

\geometry{margin=2cm}

% --------------------------------------------------
% Hyperref setup
% --------------------------------------------------
\hypersetup{
    colorlinks=true,
    linkcolor=blue,
    urlcolor=blue,
    citecolor=blue,
    pdftitle={Implementation of Different Filters}
}

% --------------------------------------------------
% Listings setup
% --------------------------------------------------
\lstset{
    backgroundcolor=\color{gray!10},
    basicstyle=\ttfamily\footnotesize,
    frame=single,
    numbers=left,
    numberstyle=\tiny,
    breaklines=true,
    tabsize=2,
    keywordstyle=\color{blue},
    commentstyle=\color{green!50!black}
}

% --------------------------------------------------
% Title
% --------------------------------------------------
\title{Effekt -- Implementation of Different Filters}
\author{Signal Processing Project}
\date{\today}

% --------------------------------------------------
% Document
% --------------------------------------------------
\begin{document}

\maketitle
\tableofcontents
\newpage

\section{State Variable Filter (SVF)}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.7\linewidth]{Effekt/SVF/SVF.png}
    \caption{SVF Discrete-Time Model (ZDF Topology)}
    \label{fig:SVF_diagram}
\end{figure}

\subsection{Description}

The State Variable Filter (SVF) is a highly versatile topology that simultaneously computes three primary filter outputs: low-pass ($y_{LP}$), high-pass ($y_{HP}$), and band-pass ($y_{BP}$). 

Based on the Zero-Delay Feedback (ZDF) structure, the band-pass output is derived as:
\[
y_{BP} = g(x - 2Ry_{BP} - gy_{BP} - s_2) + s_1
\]
Solving for $y_{BP}$ yields the stable implementation formula:
\[
y_{BP} = \frac{g(x - s_2) + s_1}{1 + g(g + 2R)}
\]
From this, the low-pass and high-pass outputs are extracted:
\begin{align*}
y_{LP} &= g \cdot y_{BP} + s_2 \\
y_{HP} &= x - 2R \cdot y_{BP} - y_{LP}
\end{align*}

This filter utilizes two trapezoidal integrators, represented as $g\xi + s_i$, where:
\begin{itemize}
    \item $g$: The zero-delay feedback gain.
    \item $\xi$: The instantaneous input of the integrator.
    \item $s_1, s_2$: The internal states (memory) of the integrators.
\end{itemize}

The parameter $g$ represents the cutoff frequency after \textbf{frequency prewarping}, which maps analog frequencies ($0$ to $\infty$) to digital frequencies ($0$ to Nyquist) using:
\[
g = \tan\left(\frac{\text{cutoff} \cdot \pi}{2}\right)
\]

\subsection{Results: Chester's Scream Analysis}

Below are the spectrograms for the outputs of the SVF filter applied to the vocals of Chester Bennington from Linkin Park's \href{https://www.youtube.com/watch?v=Gd9OhYroLN0}{"Crawling"} (20s--34s).

\begin{figure}[H]
    \centering
    \includegraphics[width=0.48\linewidth]{Effekt/SVF/band_pass_crawling.png}
    \caption{Band-pass output (Cutoff: 0.15, Resonance: 0.5)}
    \label{fig:svf_band_pass_ex}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.48\linewidth]{Effekt/SVF/low_pass_crawling.png}
    \caption{Low-pass output (Cutoff: 0.15, Resonance: 0.5)}
    \label{fig:svf_low_pass_ex}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.48\linewidth]{Effekt/SVF/high_pass_crawling.png}
    \caption{High-pass output (Cutoff: 0.15, Resonance: 0.5)}
    \label{fig:svf_high_pass_ex}
\end{figure}

\subsection{Resonance and Damping}

The variable $R$ represents the \textbf{damping factor} (the mathematical inverse of resonance). It controls the amount of band-pass signal fed back into the summing junction. While the cutoff controls the frequency boundary, $R$ controls the amplitude peak at that boundary.

\begin{figure}[H]
    \centering
    \includegraphics[width=0.48\linewidth]{Effekt/SVF/low_pass_crawling_low_res.png}
    \caption{Low-pass (Resonance: 0.01)}
    \label{fig:low_pass_crawling_low_res}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.48\linewidth]{Effekt/SVF/low_pass_crawling_super_high_res.png}
    \caption{Low-pass (Resonance: 0.99) -- Note the resonant peak.}
    \label{fig:low_pass_crawling_super_high_res}
\end{figure}

When resonance is high, an intense line appears at the cutoff frequency.

\section{Secondary Filter Types}

By linear combination of the primary SVF outputs, we can derive specialized filters.

\subsubsection*{Band-Shelving Filter}
Using a gain parameter $K$, we can boost or cut the band-pass region:
\[ y_{S} = x + 2RK \cdot y_{BP} \]
\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Effekt/SVF/band_shelving_crawling.png}
    \caption{Band-shelving (Cutoff: 0.15, Res: 0.99, K: 0.5)}
    \label{fig:shelving_ex}
\end{figure}

\subsubsection*{Notch Filter}
A notch filter is achieved by setting $K = -1$, effectively subtracting the resonant peak from the input:
\[ y_{N} = x - 2R \cdot y_{BP} \]
\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Effekt/SVF/notch_crawling.png}
    \caption{Notch filter (Cutoff: 0.15, Res: 0.99)}
    \label{fig:notch_ex}
\end{figure}

\subsubsection*{All-Pass Filter}
Setting $K = -2$ creates an all-pass response, affecting only phase:
\[ y_{AP} = x - 4R \cdot y_{BP} \]
\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Effekt/SVF/all_pass_crawling.png}
    \caption{All-pass filter (Cutoff: 0.15, Res: 0.99)}
    \label{fig:all_pass_ex}
\end{figure}

\subsubsection*{Peaking Filter}
The peaking (or phase-flip) filter is derived from the difference of the low-pass and high-pass signals:
\[ y_{P} = y_{LP} - y_{HP} \]
\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Effekt/SVF/peaking_crawling.png}
    \caption{Peaking filter output}
    \label{fig:peaking_ex}
\end{figure}

\section{Binaural Rotation}

This implementation is not a spectral filter, but rather a spatialization technique designed to simulate a monaural sound source moving horizontally ($360^{\circ}$ azimuth) around a listener's head. By transforming a mono input into a stereo output, we simulate the two primary cues used in human sound localization: Interaural Time Difference (ITD) and Interaural Level Difference (ILD).

\subsection{Interaural Time Difference (ITD)}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Effekt/Binaural/itd.png}
    \caption{Geometric representation of ITD based on the spherical head model.}
    \label{fig:itd_diagram}
\end{figure}

ITD represents the time delay incurred because the signal must travel different distances to reach each ear based on the source's position. As seen in Figure \ref{fig:itd_diagram}, a signal originating from the right will reach the right ear significantly earlier than the left.

Based on Woodworthâ€™s formula, the time delay for a spherical head is calculated as:

\begin{equation}
ITD = \frac{r}{c}(\theta + \sin\theta)
\end{equation}

Where:
\begin{itemize}
    \item \textbf{$r$} is the radius of the listener's head (typically $\approx 0.0875$ m).
    \item \textbf{$c$} is the speed of sound (approximately $343$ m/s).
    \item \textbf{$\theta$} is the azimuth angle in radians ($0$ radians being directly in front).
\end{itemize}

The $\sin\theta$ term accounts for the direct line-of-sight path to the near ear, while the $\theta$ term represents the additional distance the sound wave must travel as it diffracts around the curved surface of the head to reach the "shadowed" far ear. In this implementation, the delay is applied only to the ear further from the source; for example, if $\sin(\theta) > 0$ (source in the right hemisphere), a delay is applied to the left channel.

\subsection{Interaural Level Difference (ILD)}

ILD models the variation in sound pressure level (amplitude) reaching each ear. The ear closer to the source perceives a higher amplitude, while the further ear perceives a lower amplitude due to the "head shadow" effect. To maintain a natural perception of volume during rotation, a Constant Power Panning law is utilized:

\begin{align}
G_{left} &= \cos\left(\frac{\theta}{2} + \frac{\pi}{4}\right) \\
G_{right} &= \sin\left(\frac{\theta}{2} + \frac{\pi}{4}\right)
\end{align}

These formulas leverage the trigonometric identity $\sin^2\theta + \cos^2\theta = 1$ to ensure that the total perceived power remains constant regardless of the angle. A $45^{\circ}$ ($\pi/4$) phase shift is applied to the coordinate system to ensure that at $\theta = 0$ (center), both gains are equal to $\approx 0.707$ (-3 dB), creating a stable phantom center.

\subsubsection{Acoustic shadow}

The human head blocks high frequencies and lets lower frequencies pass just like a low pass filter when the sound is further from the ear. This is especially true when it comes from behind(most notably the pina blocks back sounds by design).

For this two low pass filters (coming from a SVF) are used, one for the left, one for the right ear. The cutoffs for the filters are defined as follows:

\begin{itemize}
    \item \textbf{normal cutoff}: 0.99 (transparent)
    \item \textbf{shadow cutoff}: 0.35 (shadow effect based on whether the sound is left or right) 
    \item \textbf{rear cutoff}: 0.2 (amplified shadow effect when in the rear side)
\end{itemize}

The cutoff "sweeped" from normal to shadow and from shadow to rear based on the left factor($\sin \theta$), right factor ($-\sin \theta$) and the rear factor ($(1 - \cos \theta)*0.5$) using linear interpolation. First sweeping from normal cutoff to side cutoff using the side factor and then from the result of that to the rear cutoff using the rear factor.

\subsection{Results}

Applying this on the same input as the SVF' here are the spectograms for the binaural rotation:

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Effekt/Binaural/init_crawling_ch_0.png}
    \caption{Binaural rotation without svf low pass filtering left channel}
    \label{fig:init_crawling_ch_0}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Effekt/Binaural/init_crawling_ch_1.png}
    \caption{Binaural rotation without svf low pass filtering right channel}
    \label{fig:init_crawling_ch_1}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Effekt/Binaural/svf_crawling_ch_0.png}
    \caption{Binaural rotation with svf low pass filtering left channel}
    \label{fig:svf_crawling_ch_0}
\end{figure}

\begin{figure}[H]
    \centering
    \includegraphics[width=0.5\linewidth]{Effekt/Binaural/svf_crawling_ch1.png}
    \caption{Binaural rotation with svf low pass filtering right channel}
    \label{fig:svf_crawling_ch_1}
\end{figure}

Most notable are the difference in phase between the channels and that for the version that uses low pass filtering we see the frequencies steadily decrease and increase. 
\end{document}